<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voices of Change - Social Impact Blog</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo">
          <h1>Voices of Change</h1>
          <p class="tagline">Amplifying stories that matter</p>
        </div>
        <nav>
          <ul>
            <li><a href="index.html" class="active">Home</a></li>
            <li><a href="pages/stories.html">Stories</a></li>
            <li><a href="pages/submit.html">Submit Your Story</a></li>
            <li><a href="pages/about.html">About Umoja</a></li>
            <li><a href="pages/contact.html">Contact</a></li>
            <li id="auth-nav-item">
              <!-- Profile dropdown will be inserted here by auth-guard -->
            </li>
          </ul>
        </nav>
        <div class="mobile-nav-toggle">
          <i class="fas fa-bars"></i>
        </div>
      </div>
    </header>

    <section class="hero">
      <div class="container">
        <h2>Share Your Voice. Inspire Change.</h2>
        <p>
          A platform dedicated to stories of mental health, gender issues, and
          social justice.
        </p>
        <div class="cta-buttons">
          <a href="pages/stories.html" class="btn primary">Read Stories</a>
          <a href="pages/submit.html" class="btn secondary">Share Your Story</a>
        </div>
      </div>
    </section>

    <section class="featured-stories">
      <div class="container">
        <h2>Featured Stories</h2>
        <div class="stories-grid">
          <!-- Stories will be loaded dynamically from database -->
        </div>
        <div class="view-all">
          <a href="pages/stories.html" class="btn secondary"
            >View All Stories</a
          >
        </div>
      </div>
    </section>

    <section class="topics">
      <div class="container">
        <h2>Explore Topics</h2>
        <div class="topics-grid">
          <a
            href="pages/stories.html?category=mental-health"
            class="topic-card"
          >
            <i class="fas fa-brain"></i>
            <h3>Mental Health</h3>
          </a>
          <a
            href="pages/stories.html?category=gender-issues"
            class="topic-card"
          >
            <i class="fas fa-venus-mars"></i>
            <h3>Gender Issues</h3>
          </a>
          <a
            href="pages/stories.html?category=social-justice"
            class="topic-card"
          >
            <i class="fas fa-balance-scale"></i>
            <h3>Social Justice</h3>
          </a>
          <a href="pages/stories.html?category=community" class="topic-card">
            <i class="fas fa-hands-helping"></i>
            <h3>Community</h3>
          </a>
        </div>
      </div>
    </section>

    <section class="newsletter">
      <div class="container">
        <h2>Stay Updated</h2>
        <p>Subscribe to our newsletter to receive new stories and updates.</p>
        <form class="newsletter-form">
          <input type="email" placeholder="Your email address" required />
          <button type="submit" class="btn primary">Subscribe</button>
        </form>
      </div>
    </section>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-about">
            <h3>Voices of Change</h3>
            <p>
              A platform dedicated to amplifying stories that drive social
              impact and inspire change.
            </p>
          </div>
          <div class="footer-links">
            <h3>Quick Links</h3>
            <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="pages/stories.html">Stories</a></li>
              <li><a href="pages/submit.html">Submit</a></li>
              <li><a href="pages/about.html">About</a></li>
              <li><a href="pages/contact.html">Contact</a></li>
            </ul>
          </div>
          <div class="footer-social">
            <h3>Connect With Us</h3>
            <div class="social-icons">
              <a href="#" aria-label="Facebook"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a href="#" aria-label="Twitter"
                ><i class="fab fa-twitter"></i
              ></a>
              <a href="#" aria-label="Instagram"
                ><i class="fab fa-instagram"></i
              ></a>
              <a href="#" aria-label="LinkedIn"
                ><i class="fab fa-linkedin-in"></i
              ></a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2023 Voices of Change. All Rights Reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Core JavaScript files - order matters! -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/notification-system.js"></script>
    <script src="js/global-error-handler.js"></script>
    <script src="js/input-sanitizer.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/database-manager.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/auth-guard.js"></script>
    <script src="js/story-image-utils.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/main.js"></script>
    <script>
      // Initialize database and then run enhanced features
      async function initHomePage() {
        try {
          console.log("üîÑ Initializing home page...");

          // Wait for required components
          let retries = 0;
          while (
            (!window.UmojaConfig || !window.DatabaseManager) &&
            retries < 100
          ) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            retries++;
          }

          if (!window.UmojaConfig || !window.DatabaseManager) {
            throw new Error("Required components not available");
          }

          window.UmojaDB =
            await window.DatabaseManager.waitForConfigAndCreate();
          console.log("‚úÖ Database initialized for index page");

          // Load stories from database and update the UI
          console.log("üîç Loading featured stories...");

          // First, debug what stories exist
          const debugResult = await window.UmojaDB.debugGetAllStories();
          console.log("üêõ DEBUG: All stories result:", debugResult);

          const result = await window.UmojaDB.getStories({ limit: 3 });
          console.log("üìä Featured stories result:", result);

          if (result?.success && result.stories?.length > 0) {
            const storiesGrid = document.querySelector(".stories-grid");
            console.log("üìç Stories grid found:", !!storiesGrid);

            if (storiesGrid) {
              // Clear existing content
              storiesGrid.innerHTML = "";
              console.log("üßπ Cleared existing content");

              // Add each story
              result.stories.forEach((story, index) => {
                console.log(
                  `üìñ Processing featured story ${index + 1}:`,
                  story.title
                );

                const readingTime = Math.ceil(
                  (story.content?.length || 0) / 250
                );
                const publishDate = new Date(
                  story.published_at || story.created_at
                ).toLocaleDateString();

                const storyCard = document.createElement("article");
                storyCard.className = "story-card";
                storyCard.dataset.storyId = story.id;

                storyCard.innerHTML = `
                  <div class="story-image">
                    <img src="${
                      window.StoryImageUtils
                        ? window.StoryImageUtils.getStoryImageUrl(story)
                        : story.image_url || "images/story-placeholder.svg"
                    }" alt="${story.title}" loading="lazy">
                  </div>
                  <div class="story-content">
                    <span class="category category-${story.category}">${
                  story.category?.replace("-", " ") || "General"
                }</span>
                    <h3>${story.title}</h3>
                    <p>${
                      story.summary || story.content.substring(0, 120) + "..."
                    }</p>
                    <div class="story-meta">
                      <span class="author"><i class="fas fa-user"></i> ${
                        story.author_name
                      }</span>
                      <span class="date"><i class="fas fa-calendar"></i> ${publishDate}</span>
                      <span class="reading-time"><i class="fas fa-clock"></i> ${readingTime} min read</span>
                    </div>
                  </div>
                  <a href="pages/stories.html?id=${
                    story.id
                  }" class="story-link" aria-label="Read more about ${
                  story.title
                }"></a>
                `;

                storiesGrid.appendChild(storyCard);
              });

              console.log(
                `‚úÖ Added ${result.stories.length} featured stories to home page`
              );

              // Add animation to story cards
              const storyCards = document.querySelectorAll(".story-card");
              if (storyCards.length > 0) {
                const observer = new IntersectionObserver(
                  (entries) => {
                    entries.forEach((entry) => {
                      if (entry.isIntersecting) {
                        entry.target.classList.add("fadeIn");
                        observer.unobserve(entry.target);
                      }
                    });
                  },
                  { threshold: 0.1 }
                );

                storyCards.forEach((card) => {
                  observer.observe(card);
                });
              }
            }
          } else {
            console.log("üì≠ No featured stories found");
            const storiesGrid = document.querySelector(".stories-grid");
            if (storiesGrid) {
              storiesGrid.innerHTML = `
                <div class="no-stories">
                  <i class="fas fa-book-open" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                  <h3 style="color: #666; margin-bottom: 0.5rem;">No Stories Yet</h3>
                  <p style="color: #999; margin-bottom: 1.5rem;">Be the first to share your story with the community.</p>
                  <a href="pages/submit.html" class="btn primary">Share Your Story</a>
                </div>
              `;
              storiesGrid.style.cssText = `
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 300px;
                text-align: center;
              `;
            }
          }
        } catch (error) {
          console.error("‚ùå Home page initialization failed:", error);
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initHomePage);
      } else {
        initHomePage();
      }
    </script>
  </body>
</html>
